<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa Mental com Conex√£o Intuitiva</title>
  <link rel="icon" href="data:,">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: #f8f9fa;
      overflow: hidden;
      touch-action: none;
    }

    #mindmap-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      cursor: grab;
      overflow: hidden;
      background-color: #f8f9fa;
      background-image: 
        radial-gradient(circle at 1px 1px, #e0e0e0 1px, transparent 0);
      background-size: 20px 20px;
    }

    .card {
      position: absolute;
      width: 260px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      padding: 16px;
      cursor: move;
      z-index: 10;
      transition: transform 0.2s, box-shadow 0.2s;
      border: 1px solid #e9ecef;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }

    .card-header {
      font-weight: 600;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 16px;
      color: #212529;
    }

    .card-content {
      min-height: 60px;
      margin-bottom: 12px;
      color: #495057;
      line-height: 1.5;
    }

    .card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .card-btn {
      flex: 1;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .edit-btn {
      background: #e9ecef;
      color: #495057;
    }

    .edit-btn:hover {
      background: #dee2e6;
    }

    .delete-btn {
      background: #fff5f5;
      color: #fa5252;
    }

    .delete-btn:hover {
      background: #ffebeb;
    }

    .connection-mode-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #4dabf7;
      color: white;
      border: none;
      box-shadow: 0 4px 12px rgba(77, 171, 247, 0.3);
      cursor: pointer;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.3s;
    }

    .connection-mode-btn.active {
      background: #339af0;
      transform: rotate(45deg);
    }

    .connection-line {
      position: absolute;
      height: 3px;
      background: #4dabf7;
      transform-origin: 0 0;
      z-index: 5;
      pointer-events: none;
      border-radius: 3px;
    }

    .connection-arrow {
      position: absolute;
      width: 12px;
      height: 12px;
      background: #4dabf7;
      border-radius: 2px;
      transform: rotate(45deg);
      right: -6px;
      top: -5px;
      z-index: 6;
    }

    .connection-label {
      position: absolute;
      background: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      color: #495057;
      border: 1px solid #e9ecef;
      z-index: 7;
      pointer-events: none;
      transform: translateY(-50%);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .temp-connection {
      position: absolute;
      height: 3px;
      background: #4dabf7;
      transform-origin: 0 0;
      z-index: 8;
      pointer-events: none;
      border-radius: 3px;
      opacity: 0.7;
    }

    .connection-hint {
      position: absolute;
      width: 40px;
      height: 40px;
      background: rgba(77, 171, 247, 0.2);
      border-radius: 50%;
      z-index: 9;
      pointer-events: none;
      transform: translate(-50%, -50%);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.7; }
      70% { transform: translate(-50%, -50%) scale(1.3); opacity: 0.3; }
      100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.7; }
    }

    .sidebar {
      position: fixed;
      top: 20px;
      left: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      padding: 16px;
      z-index: 100;
      max-width: 300px;
    }

    .add-card-btn {
      background: #4dabf7;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 500;
      margin-bottom: 12px;
      width: 100%;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .add-card-btn:hover {
      background: #339af0;
    }

    .connection-instruction {
      font-size: 13px;
      color: #868e96;
      margin-top: 8px;
      line-height: 1.4;
    }

    .connection-type-selector {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      padding: 8px;
      z-index: 99;
      display: none;
      flex-direction: column;
      gap: 8px;
    }

    .connection-type-btn {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: none;
      background: #f8f9fa;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .connection-type-btn:hover {
      background: #e9ecef;
    }

    .connection-type-btn.active {
      background: #4dabf7;
      color: white;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <button class="add-card-btn" id="add-card-btn">
      <span>+</span> Adicionar Card
    </button>
    <p class="connection-instruction">
      Modo Conex√£o: Clique no bot√£o azul abaixo e desenhe linhas entre os cards para conect√°-los
    </p>
  </div>
  
  <div id="mindmap-container"></div>
  
  <button class="connection-mode-btn" id="connection-mode-btn">‚úèÔ∏è</button>
  
  <div class="connection-type-selector" id="connection-type-selector">
    <button class="connection-type-btn" data-type="solid">‚Äï</button>
    <button class="connection-type-btn" data-type="dashed">--</button>
    <button class="connection-type-btn active" data-type="arrow">‚Üí</button>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

  <script>
    // Configura√ß√£o do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAe-C2cBa5QWZwIW-KuuxYqe4yaM0IR8-o",
      authDomain: "tragedy-3ae14.firebaseapp.com",
      databaseURL: "https://tragedy-3ae14-default-rtdb.firebaseio.com",
      projectId: "tragedy-3ae14",
      storageBucket: "tragedy-3ae14.appspot.com",
      messagingSenderId: "623670764649",
      appId: "1:623670764649:web:beb774fc0105d991552ef8"
    };

    // Inicializa o Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const cardsRef = database.ref('mindmap/cards');
    const connectionsRef = database.ref('mindmap/connections');

    // Vari√°veis de estado
    let cards = [];
    let connections = [];
    let isDragging = false;
    let isPanning = false;
    let startX, startY;
    let offsetX = 0, offsetY = 0;
    let selectedCard = null;
    let connectionMode = false;
    let currentConnection = null;
    let connectionStart = null;
    let tempLine = null;
    let connectionType = 'arrow';
    let connectionLabel = '';

    // Elementos DOM
    const container = document.getElementById('mindmap-container');
    const addCardBtn = document.getElementById('add-card-btn');
    const connectionModeBtn = document.getElementById('connection-mode-btn');
    const connectionTypeSelector = document.getElementById('connection-type-selector');

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      loadMindMap();
    });

    // Carregar mapa mental do Firebase
    function loadMindMap() {
      cardsRef.on('value', (snapshot) => {
        const cardsData = snapshot.val();
        cards = cardsData ? Object.keys(cardsData).map(key => ({
          id: key,
          ...cardsData[key]
        })) : [];
        renderCards();
      });

      connectionsRef.on('value', (snapshot) => {
        const connectionsData = snapshot.val();
        connections = connectionsData ? Object.keys(connectionsData).map(key => ({
          id: key,
          ...connectionsData[key]
        })) : [];
        renderConnections();
      });
    }

    // Renderizar cards
    function renderCards() {
      document.querySelectorAll('.card').forEach(card => {
        if (!card.classList.contains('temp')) card.remove();
      });

      cards.forEach(card => {
        const cardEl = document.createElement('div');
        cardEl.className = 'card';
        cardEl.dataset.id = card.id;
        cardEl.style.left = `${card.x + offsetX}px`;
        cardEl.style.top = `${card.y + offsetY}px`;
        
        cardEl.innerHTML = `
          <div class="card-header">
            ${card.title || 'Novo Card'}
          </div>
          <div class="card-content">
            ${card.content || 'Clique para editar...'}
          </div>
          <div class="card-actions">
            <button class="card-btn edit-btn edit-title-btn" data-id="${card.id}">
              <span>‚úèÔ∏è</span> T√≠tulo
            </button>
            <button class="card-btn edit-btn edit-content-btn" data-id="${card.id}">
              <span>üìù</span> Texto
            </button>
            <button class="card-btn delete-btn" data-id="${card.id}">
              <span>üóëÔ∏è</span>
            </button>
          </div>
        `;

        container.appendChild(cardEl);
        setupCardEvents(cardEl);
        
        // Adiciona ponto de conex√£o
        if (connectionMode) {
          addConnectionHint(cardEl);
        }
      });
    }

    // Adicionar dica de conex√£o
    function addConnectionHint(cardEl) {
      const hint = document.createElement('div');
      hint.className = 'connection-hint';
      hint.dataset.target = cardEl.dataset.id;
      
      const rect = cardEl.getBoundingClientRect();
      hint.style.left = `${rect.left + rect.width/2 - container.getBoundingClientRect().left}px`;
      hint.style.top = `${rect.top + rect.height/2 - container.getBoundingClientRect().top}px`;
      
      container.appendChild(hint);
    }

    // Remover dicas de conex√£o
    function removeConnectionHints() {
      document.querySelectorAll('.connection-hint').forEach(hint => hint.remove());
    }

    // Renderizar conex√µes
    function renderConnections() {
      document.querySelectorAll('.connection-line').forEach(line => line.remove());
      
      connections.forEach(conn => {
        const fromCard = cards.find(c => c.id === conn.from);
        const toCard = cards.find(c => c.id === conn.to);

        if (fromCard && toCard) {
          createConnection(fromCard, toCard, conn.type, conn.label);
        }
      });
    }

    // Criar conex√£o visual
    function createConnection(fromCard, toCard, type = 'arrow', label = '') {
      const fromEl = document.querySelector(`.card[data-id="${fromCard.id}"]`);
      const toEl = document.querySelector(`.card[data-id="${toCard.id}"]`);

      if (!fromEl || !toEl) return;

      const fromRect = fromEl.getBoundingClientRect();
      const toRect = toEl.getBoundingClientRect();

      const fromCenter = {
        x: fromRect.left + fromRect.width/2 - container.getBoundingClientRect().left,
        y: fromRect.top + fromRect.height/2 - container.getBoundingClientRect().top
      };
      
      const toCenter = {
        x: toRect.left + toRect.width/2 - container.getBoundingClientRect().left,
        y: toRect.top + toRect.height/2 - container.getBoundingClientRect().top
      };

      const angle = Math.atan2(toCenter.y - fromCenter.y, toCenter.x - fromCenter.x);
      const length = Math.sqrt(
        Math.pow(toCenter.x - fromCenter.x, 2) + 
        Math.pow(toCenter.y - fromCenter.y, 2)
      );

      // Ajusta os pontos de in√≠cio/fim para as bordas dos cards
      const fromPoint = getBorderPoint(fromCenter, toCenter, fromRect);
      const toPoint = getBorderPoint(toCenter, fromCenter, toRect);

      const finalLength = Math.sqrt(
        Math.pow(toPoint.x - fromPoint.x, 2) + 
        Math.pow(toPoint.y - fromPoint.y, 2)
      );

      const finalAngle = Math.atan2(toPoint.y - fromPoint.y, toPoint.x - fromPoint.x);

      const line = document.createElement('div');
      line.className = 'connection-line';
      line.dataset.connection = `${fromCard.id}-${toCard.id}`;
      
      if (type === 'dashed') {
        line.style.background = 'repeating-linear-gradient(to right, #4dabf7, #4dabf7 5px, transparent 5px, transparent 10px)';
      }
      
      line.style.width = `${finalLength}px`;
      line.style.left = `${fromPoint.x}px`;
      line.style.top = `${fromPoint.y}px`;
      line.style.transform = `rotate(${finalAngle}rad)`;
      
      container.appendChild(line);

      if (type === 'arrow') {
        const arrow = document.createElement('div');
        arrow.className = 'connection-arrow';
        line.appendChild(arrow);
      }

      if (label) {
        const labelEl = document.createElement('div');
        labelEl.className = 'connection-label';
        labelEl.textContent = label;
        
        const midX = fromPoint.x + (toPoint.x - fromPoint.x) * 0.5;
        const midY = fromPoint.y + (toPoint.y - fromPoint.y) * 0.5;
        
        labelEl.style.left = `${midX}px`;
        labelEl.style.top = `${midY}px`;
        
        container.appendChild(labelEl);
      }
    }

    // Calcula ponto na borda do card
    function getBorderPoint(center, otherCenter, rect) {
      const width = rect.width;
      const height = rect.height;
      
      const dx = otherCenter.x - center.x;
      const dy = otherCenter.y - center.y;
      
      // Calcula o ponto de interse√ß√£o com a borda do ret√¢ngulo
      let x, y;
      
      if (Math.abs(dx) > Math.abs(dy)) {
        const slope = dy / dx;
        x = dx > 0 ? width/2 : -width/2;
        y = slope * x;
      } else {
        const slope = dx / dy;
        y = dy > 0 ? height/2 : -height/2;
        x = slope * y;
      }
      
      return {
        x: center.x + x,
        y: center.y + y
      };
    }

    // Configurar eventos do card
    function setupCardEvents(cardEl) {
      const deleteBtn = cardEl.querySelector('.delete-btn');
      const editTitleBtn = cardEl.querySelector('.edit-title-btn');
      const editContentBtn = cardEl.querySelector('.edit-content-btn');

      // Arrastar card
      cardEl.addEventListener('mousedown', (e) => {
        if (connectionMode) return;
        if (e.target === deleteBtn || e.target === editTitleBtn || e.target === editContentBtn) return;
        
        isDragging = true;
        selectedCard = cardEl;
        startX = e.clientX - parseInt(cardEl.style.left || '0');
        startY = e.clientY - parseInt(cardEl.style.top || '0');
        e.preventDefault();
      });

      // Editar t√≠tulo
      editTitleBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const card = cards.find(c => c.id === cardEl.dataset.id);
        if (!card) return;
        
        const newTitle = prompt('Editar t√≠tulo:', card.title || 'Novo Card');
        if (newTitle !== null) {
          updateCard(card.id, { title: newTitle });
        }
      });

      // Editar conte√∫do
      editContentBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const card = cards.find(c => c.id === cardEl.dataset.id);
        if (!card) return;
        
        const newContent = prompt('Editar conte√∫do:', card.content || '');
        if (newContent !== null) {
          updateCard(card.id, { content: newContent });
        }
      });

      // Deletar card
      deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (confirm('Tem certeza que deseja excluir este card e todas as suas conex√µes?')) {
          deleteCard(cardEl.dataset.id);
        }
      });

      // Iniciar conex√£o (no modo conex√£o)
      if (connectionMode) {
        cardEl.addEventListener('mousedown', (e) => {
          if (!connectionMode) return;
          e.stopPropagation();
          
          connectionStart = cardEl.dataset.id;
          
          // Cria linha tempor√°ria
          tempLine = document.createElement('div');
          tempLine.className = 'temp-connection';
          container.appendChild(tempLine);
          
          const rect = cardEl.getBoundingClientRect();
          const startX = rect.left + rect.width/2 - container.getBoundingClientRect().left;
          const startY = rect.top + rect.height/2 - container.getBoundingClientRect().top;
          
          function moveTempLine(e) {
            const endX = e.clientX - container.getBoundingClientRect().left;
            const endY = e.clientY - container.getBoundingClientRect().top;
            
            const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
            const angle = Math.atan2(endY - startY, endX - startX);
            
            tempLine.style.width = `${length}px`;
            tempLine.style.left = `${startX}px`;
            tempLine.style.top = `${startY}px`;
            tempLine.style.transform = `rotate(${angle}rad)`;
          }
          
          function endConnection(e) {
            document.removeEventListener('mousemove', moveTempLine);
            document.removeEventListener('mouseup', endConnection);
            
            const elements = document.elementsFromPoint(e.clientX, e.clientY);
            const targetCard = elements.find(el => el.classList.contains('card'));
            
            if (targetCard && targetCard !== cardEl) {
              connectionLabel = prompt('Digite um r√≥tulo para a conex√£o (opcional):', '');
              addConnection(connectionStart, targetCard.dataset.id, connectionType, connectionLabel);
            }
            
            if (tempLine) {
              tempLine.remove();
              tempLine = null;
            }
          }
          
          document.addEventListener('mousemove', moveTempLine);
          document.addEventListener('mouseup', endConnection);
        });
      }
    }

    // Adicionar nova conex√£o
    function addConnection(fromId, toId, type = 'arrow', label = '') {
      const newConnection = { from: fromId, to: toId, type, label };
      
      const exists = connections.some(conn => 
        (conn.from === fromId && conn.to === toId) || 
        (conn.from === toId && conn.to === fromId)
      );
      
      if (!exists) {
        connectionsRef.push(newConnection);
      }
    }

    // Adicionar novo card
    function addCard() {
      const newCard = {
        id: Date.now().toString(),
        x: window.innerWidth / 2 - offsetX - 130,
        y: window.innerHeight / 2 - offsetY - 65,
        title: 'Novo Card',
        content: ''
      };
      
      cardsRef.child(newCard.id).set(newCard);
    }

    // Atualizar card
    function updateCard(id, updates) {
      cardsRef.child(id).update(updates);
    }

    // Deletar card
    function deleteCard(id) {
      cardsRef.child(id).remove();
      
      const updatedConnections = {};
      Object.keys(connections).forEach(key => {
        const conn = connections[key];
        if (conn.from !== id && conn.to !== id) {
          updatedConnections[key] = conn;
        }
      });
      
      connectionsRef.set(updatedConnections);
    }

    // Alternar modo de conex√£o
    function toggleConnectionMode() {
      connectionMode = !connectionMode;
      connectionModeBtn.classList.toggle('active');
      
      if (connectionMode) {
        // Entrou no modo conex√£o
        container.style.cursor = 'crosshair';
        connectionTypeSelector.style.display = 'flex';
        
        // Adiciona dicas de conex√£o
        document.querySelectorAll('.card').forEach(card => {
          addConnectionHint(card);
        });
      } else {
        // Saiu do modo conex√£o
        container.style.cursor = 'grab';
        connectionTypeSelector.style.display = 'none';
        
        // Remove dicas de conex√£o
        removeConnectionHints();
      }
    }

    // Configurar event listeners globais
    function setupEventListeners() {
      addCardBtn.addEventListener('click', addCard);
      
      // Modo conex√£o
      connectionModeBtn.addEventListener('click', toggleConnectionMode);
      
      // Selecionar tipo de conex√£o
      document.querySelectorAll('.connection-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.connection-type-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          connectionType = btn.dataset.type;
        });
      });

      // Panning (mover o mapa)
      container.addEventListener('mousedown', (e) => {
        if (connectionMode) return;
        if (e.target === container) {
          isPanning = true;
          startX = e.clientX - offsetX;
          startY = e.clientY - offsetY;
          container.style.cursor = 'grabbing';
        }
      });

      document.addEventListener('mousemove', (e) => {
        if (isPanning) {
          offsetX = e.clientX - startX;
          offsetY = e.clientY - startY;
          renderCards();
          renderConnections();
        } else if (isDragging && selectedCard) {
          const cardId = selectedCard.dataset.id;
          const cardIndex = cards.findIndex(c => c.id === cardId);
          
          if (cardIndex !== -1) {
            const newX = e.clientX - startX;
            const newY = e.clientY - startY;
            
            selectedCard.style.left = `${newX}px`;
            selectedCard.style.top = `${newY}px`;
            
            updateCard(cardId, {
              x: newX - offsetX,
              y: newY - offsetY
            });
          }
        }
      });

      document.addEventListener('mouseup', () => {
        isPanning = false;
        isDragging = false;
        selectedCard = null;
        if (!connectionMode) {
          container.style.cursor = 'grab';
        }
      });

      // Impede o menu de contexto
      document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
      });
    }
  </script>
</body>
</html>